# Week11 Assignment

> 班级：202111
>
> 学号：19241027
>
> 姓名：胡峻诚

*阅读教材第七章，回答以下问题。*

## 1. 简述信号量的作用，如何利用信号量实现同步和互斥？

> 信号量的作用：用来解决进程间的同步与互斥问题的一种进程间通信机制，包括一个称为信号量的变量和在该信号量下等待资源的进程等待队列，以及对信号量进行的两个原子操作（P/V 操作）。
>
> 同步：由一个无条件执行的进程开始，信号量资源初始值为 0，进程结束时`V(S)`操作，信号量资源 +1，此时通知别的进程。需要该资源的进程，打破阻塞，`P(S)`操作，去访问临界资源。
>
> 互斥：`P(S)`操作，资源 -1，则其余进程不可再访问该临界资源。`V(S)`操作结束后，资源 +1，此时别的进程才可进行是否可以访问判断。

## 2.简述共享内存的作用和用法，共享内存为什么需要与信号量一起使用？

> 作用：省去当进程向队列/管道写⼊数据时和读取消息时数据从用户地址向内核地址空间复制的操作。
>
> 用法：
>
> - 创建：从内存中获得一段共享内存区域`shmget()`
> - 映射：`shmat()`
> - 撤销映射：`shmdt()`
>
> 与信号量一起使用：保证某块共享内存在被其他进程进行读或写时不会被其他进程的操作干扰，需要信号量来加上对应的锁。

## 3. 有以下代码：

```C
int fd1,fd2,fd3,fd4;
fd1=open("a.txt",O_RDONLY);
fd2=open("b.txt",O_WRONLY);
fd3=dup(fd1);
fd4=dup2(fd2,0);
```

请问，最后fd1,fd2,fd3,fd4的值分别是多少？并解释原因。

> ```c
> fd1 = 3
> fd2 = 4
> fd3 = 5
> fd4 = 0
> ```
>
> 原因：
>
> open 返回的是文件描述符。文件描述符是打开的文件数量减去一。
>
> 对于每个进程，都会打开 3 个描述符，分别是标准输入（0），标准输出（1），标准错误（2）。
>
> 1. `fd1`打开了`a.txt`，由于这是第一个打开的文件，所以返回的描述符应该为 3
> 2. `fd2`打开了`b.txt`，作为下一个打开的文件，所以返回的描述符应该为 4
> 3. `fd3`复制了`fd1`，而`dup`函数的作用是复制一个和 fd1 指向同一个文件的文件描述符，并且新的文件符总是取最小的可用值，所以返回的描述符应该为 5
> 4. 而`dup2(fd2,0)`的作用就是将`fd2`所指的文件将其拷贝到 0 之后，然后将 0 返回，所以`fd4`为 0，且 0 也是`b.txt`的文件描述符。

## 4. 请查阅资料简述进程间通信的 System V、POSIX 两种标准之间的差异性

> |                       | System V                                                     | POSIX                                                        |
> | --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
> | 效率性能              | 在同步互斥手段方面的无竞争条件下是无论何时都会陷⼊内核，性能稍低。 | 在同步互斥手段方面的无竞争条件下是不会陷⼊内核，性能较⾼。   |
> | 冗余可靠性            | 提供了 SEM_UNDO 选项可以解决成功获取信号量后，进程如果意外终止，将无法释放信号量个问题，可靠性高。 | sem_wait 函数成功获取信号量后，进程如果意外终⽌，将无法释放信号量，可靠性差。 |
> | 操作系统              | 操作系统实现相当⼴泛。                                       | 可能有小部分操作系统没有实现 POSIX 标准。                    |
> | 移植性                | 不同操作系统 System V 存在一些差异。                         | 可移植性。                                                   |
> | 进程间&线程间通信同步 | 进程间通信，线程间使用较少。线程相对于进程是轻量级的。每次调用都会陷⼊内核的接口，会丧失线程的轻量优势。 | 优。                                                         |

## 5. 编写C程序实现如下功能：创建父子进程，父子进程之间通过管道进行通信，父进程向子进程发送字符串，子进程收到该字符串后，将该字符串的最后5个字符发送给父进程。

> ```c
> #include <stdio.h>
> #include <unistd.h>
> #include <string.h>
> 
> char par_write[25] = "HuaYe_19241027";
> char par_read[25];
> char chi_write[25], chi_read[25];
> 
> int main () {
>     int pipefds[2];
>     pipe(pipefds);
>     if (fork()) {
>         printf("父进程写入管道：%s\n", par_write);
>         write(pipefds[1], par_write, sizeof(par_write));
>         sleep(5);
>         read(pipefds[0], par_read, sizeof(par_read));
>         printf("父进程从管道读出：%s\n", par_read);
>     } else {
>         sleep(2);
>         read(pipefds[0], chi_read, sizeof(chi_read));
>         printf("子进程从管道读出：%s\n", chi_read);
>         for (int i = strlen(chi_read) - 5, j = 0; i < strlen(chi_read); i++, j++) {
>             chi_write[j] = chi_read[i];
>         }
>         printf("子进程写入管道：%s\n", chi_write);
>         write(pipefds[1], chi_write, sizeof(chi_write));
>     }
> }
> ```
>
> ![截屏2022-11-08 15.45.03](https://raw.githubusercontent.com/hjc-owo/hjc-owo.github.io/img/202211081545401.png)

